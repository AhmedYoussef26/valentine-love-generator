<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Love Page Generator</title>
  <style>
    body{font-family:Arial,system-ui,sans-serif;margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;background:#0b1020;color:#fff}
    .card{width:min(860px,92vw);background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:18px;padding:22px}
    h1{margin:0 0 10px;font-size:24px}
    p{margin:0 0 18px;opacity:.9}
    label{display:block;margin:12px 0 6px;font-weight:700}
    input,textarea,select{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.25);color:#fff;padding:12px}
    textarea{min-height:110px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    button{border:0;border-radius:999px;padding:12px 16px;font-weight:800;cursor:pointer}
    .primary{background:#ff4d7d;color:#fff}
    .ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,.25)}
    .out{margin-top:14px;padding:12px;border-radius:12px;background:rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.12);display:none}
    .small{font-size:13px;opacity:.85}
    code{word-break:break-all}
    .memBox{margin-top:12px;padding:14px;border-radius:14px;background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.12)}
    .memItem{display:grid;grid-template-columns:110px 1fr;gap:12px;align-items:center;margin-top:10px}
    .thumb{width:110px;height:110px;border-radius:14px;object-fit:cover;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.08)}
    .hint{opacity:.8;font-size:13px;margin-top:6px;line-height:1.5}
    .warn{opacity:.9;font-size:13px;margin-top:10px;color:#ffd1dc}
  </style>
</head>
<body>
  <div class="card">
    <h1>Valentine Love Page Generator ‚ù§Ô∏è</h1>
    <p>Type your message, add up to 4 photos with captions, then generate a private shareable link.</p>

    <div class="row">
      <div>
        <label>Her/His name</label>
        <input id="toName" maxlength="40" placeholder="e.g., Sara" />
      </div>
      <div>
        <label>Your name (optional)</label>
        <input id="fromName" maxlength="40" placeholder="e.g., Ahmed" />
      </div>
    </div>

    <label>Your message</label>
    <textarea id="msg" maxlength="420" placeholder="Write something sweet... (max 420 chars)"></textarea>

    <div class="row">
      <div>
        <label>Theme</label>
        <select id="theme">
          <option value="rose">Rose</option>
          <option value="midnight">Midnight</option>
          <option value="sunset">Sunset</option>
        </select>
      </div>
      <div>
        <label>Surprise ending line</label>
        <input id="endingLine" maxlength="120" placeholder="e.g., These are just a few of my favorite moments with you üíå" />
      </div>
    </div>

    <div class="memBox">
      <label>Memory photos (up to 4)</label>
      <input type="file" id="photos" accept="image/*" multiple />
      <div class="hint">
        Tip: Choose normal-sized photos for a shorter link (avoid very large 4K images).
      </div>
      <div class="warn" id="sizeWarn" style="display:none"></div>

      <div id="memoriesUI"></div>
    </div>

    <div class="btns">
      <button class="primary" id="gen">Generate link</button>
      <button class="ghost" id="copy" disabled>Copy link</button>
      <button class="ghost" id="open" disabled>Open page</button>
      <button class="ghost" id="reset" type="button">Reset</button>
    </div>

    <div class="out" id="out">
      <div class="small">Your shareable link:</div>
      <code id="link"></code>
      <div class="small" style="margin-top:10px">
        Note: The link contains what you typed (and your selected photos). Don‚Äôt include sensitive private info.
      </div>
    </div>
  </div>

  <script>
    // URL-safe Base64 helpers
    function b64urlEncode(str){
      const b64 = btoa(unescape(encodeURIComponent(str)));
      return b64.replaceAll('+','-').replaceAll('/','_').replaceAll('=','');
    }

    function getBaseUrl(){
      // Assumes generator.html and index.html are in same folder
      const url = new URL(window.location.href);
      url.pathname = url.pathname.replace(/generator\.html$/,'index.html');
      url.hash = '';
      url.search = '';
      return url.toString();
    }

    const el = (id)=>document.getElementById(id);

    // Resize & compress image to keep the link shorter
    // - maxDim: 720px
    // - jpeg quality: 0.72
    async function fileToCompressedDataURL(file, maxDim=720, quality=0.72){
      const img = await new Promise((resolve, reject)=>{
        const im = new Image();
        im.onload = ()=>resolve(im);
        im.onerror = reject;
        im.src = URL.createObjectURL(file);
      });

      const w = img.naturalWidth || img.width;
      const h = img.naturalHeight || img.height;
      const scale = Math.min(1, maxDim / Math.max(w, h));
      const nw = Math.max(1, Math.round(w * scale));
      const nh = Math.max(1, Math.round(h * scale));

      const canvas = document.createElement('canvas');
      canvas.width = nw; canvas.height = nh;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, nw, nh);

      // convert to jpeg to shrink
      const dataUrl = canvas.toDataURL('image/jpeg', quality);
      URL.revokeObjectURL(img.src);
      return dataUrl;
    }

    let selectedFiles = [];
    function renderMemoriesUI(){
      const box = el('memoriesUI');
      box.innerHTML = "";

      if(!selectedFiles.length){
        return;
      }

      selectedFiles.forEach((file, i)=>{
        const wrap = document.createElement('div');
        wrap.className = 'memItem';

        const thumb = document.createElement('img');
        thumb.className = 'thumb';
        thumb.alt = `Memory ${i+1}`;
        thumb.src = URL.createObjectURL(file);

        const right = document.createElement('div');

        const lab = document.createElement('label');
        lab.style.margin = "0 0 6px";
        lab.style.fontSize = "14px";
        lab.textContent = `Caption for photo ${i+1}`;

        const input = document.createElement('input');
        input.placeholder = "e.g., Our first trip together ‚ú®";
        input.maxLength = 120;
        input.id = `cap_${i}`;

        right.appendChild(lab);
        right.appendChild(input);

        wrap.appendChild(thumb);
        wrap.appendChild(right);
        box.appendChild(wrap);
      });
    }

    el('photos').addEventListener('change', ()=>{
      const files = [...el('photos').files].slice(0,4);
      selectedFiles = files;
      renderMemoriesUI();

      // Simple size warning
      const totalMB = files.reduce((acc,f)=>acc+(f.size||0),0) / (1024*1024);
      if(totalMB > 12){
        el('sizeWarn').style.display = "block";
        el('sizeWarn').textContent = "Your selected photos are quite large. For a shorter link, pick smaller photos if possible.";
      } else {
        el('sizeWarn').style.display = "none";
      }
    });

    function makePayload(){
      const toName = el('toName').value.trim();
      const fromName = el('fromName').value.trim();
      const msg = el('msg').value.trim();
      const theme = el('theme').value;
      const endingLine = (el('endingLine').value.trim() || "These are just a few of my favorite moments with you üíå").slice(0,120);

      if(!toName) throw new Error("Please enter a name.");
      if(!msg) throw new Error("Please enter a message.");

      return { toName, fromName, msg, theme, endingLine };
    }

    let lastLink = "";

    el('gen').addEventListener('click', async ()=>{
      try{
        const payload = makePayload();

        // Build memories array: [{img, text}]
        const memories = [];
        for(let i=0; i<selectedFiles.length; i++){
          const file = selectedFiles[i];
          const imgData = await fileToCompressedDataURL(file, 720, 0.72);
          const capInput = document.getElementById(`cap_${i}`);
          const cap = (capInput?.value || "").trim().slice(0,120);
          memories.push({ img: imgData, text: cap });
        }

        payload.memories = memories;

        const encoded = b64urlEncode(JSON.stringify(payload));
        lastLink = getBaseUrl() + "#d=" + encoded;

        el('link').textContent = lastLink;
        el('out').style.display = "block";
        el('copy').disabled = false;
        el('open').disabled = false;

      } catch(err){
        alert(err.message || String(err));
      }
    });

    el('copy').addEventListener('click', async ()=>{
      try{
        await navigator.clipboard.writeText(lastLink);
        alert("Copied!");
      }catch{
        alert("Copy failed. You can manually select the link and copy it.");
      }
    });

    el('open').addEventListener('click', ()=>{
      if(lastLink) window.open(lastLink, "_blank");
    });

    el('reset').addEventListener('click', ()=>{
      ['toName','fromName','msg','endingLine'].forEach(id=>el(id).value="");
      el('theme').value="rose";
      el('photos').value="";
      selectedFiles = [];
      el('memoriesUI').innerHTML="";
      el('sizeWarn').style.display="none";
      el('out').style.display="none";
      el('copy').disabled=true;
      el('open').disabled=true;
      lastLink="";
    });
  </script>
</body>
</html>
