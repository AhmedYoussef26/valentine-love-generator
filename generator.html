<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Love Page Generator</title>

  <!-- Uploadcare (official widget) -->
  <script>
    UPLOADCARE_PUBLIC_KEY = "584027466a1c18e0e9ed";
    UPLOADCARE_LOCALE = "en";
  </script>
  <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js" charset="utf-8"></script>

  <style>
    body{font-family:Arial,system-ui,sans-serif;margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;background:#0b1020;color:#fff}
    .card{width:min(900px,92vw);background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:18px;padding:22px}
    h1{margin:0 0 10px;font-size:24px}
    p{margin:0 0 16px;opacity:.9}
    label{display:block;margin:12px 0 6px;font-weight:800}
    input,textarea,select{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.25);color:#fff;padding:12px}
    textarea{min-height:110px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    button{border:0;border-radius:999px;padding:12px 16px;font-weight:900;cursor:pointer}
    .primary{background:#ff4d7d;color:#fff}
    .ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,.25)}
    .out{margin-top:14px;padding:12px;border-radius:12px;background:rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.12);display:none}
    .small{font-size:13px;opacity:.85;line-height:1.5}
    code{word-break:break-all}
    .memBox{margin-top:12px;padding:14px;border-radius:14px;background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.12)}
    .memItem{display:grid;grid-template-columns:1fr;gap:8px;margin-top:10px}
    .pill{display:inline-block;padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.18);font-size:13px;opacity:.9}
    .warning{margin-top:10px;color:#ffd1dc;font-size:13px;opacity:.95}
  </style>
</head>
<body>
  <div class="card">
    <h1>Valentine Love Page Generator ‚ù§Ô∏è</h1>
    <p>Create a private love page with photos + captions. Generate a short shareable link.</p>

    <div class="row">
      <div>
        <label>Her/His name</label>
        <input id="toName" maxlength="40" placeholder="e.g., Sara" />
      </div>
      <div>
        <label>Your name (optional)</label>
        <input id="fromName" maxlength="40" placeholder="e.g., Ahmed" />
      </div>
    </div>

    <label>Your message</label>
    <textarea id="msg" maxlength="420" placeholder="Write something sweet... (max 420 chars)"></textarea>

    <div class="row">
      <div>
        <label>Theme</label>
        <select id="theme">
          <option value="rose">Rose</option>
          <option value="midnight">Midnight</option>
          <option value="sunset">Sunset</option>
        </select>
      </div>
      <div>
        <label>Surprise ending line</label>
        <input id="endingLine" maxlength="120" placeholder="e.g., These are just a few of my favorite moments with you üíå" />
      </div>
    </div>

    <div class="memBox">
      <label>Memory photos (up to 4)</label>

      <!-- Uploadcare widget input -->
      <input
        type="hidden"
        role="uploadcare-uploader"
        id="uploader"
        data-multiple="true"
        data-images-only="true"
        data-max-files="4"
        data-clearable="true"
        data-crop=""  />

      <div class="small" style="margin-top:8px">
        After uploading, add a caption under each photo.
      </div>

      <div id="memoriesUI"></div>

      <div class="warning" id="keyWarn" style="display:none">
        Uploadcare Public Key is missing. Replace UPLOADCARE_PUBLIC_KEY_HERE in generator.html.
      </div>

      <div class="small" style="margin-top:10px">
        Privacy note: your photos are uploaded to a third-party host (Uploadcare) to keep the share link short.
      </div>
    </div>

    <div class="btns">
      <button class="primary" id="gen">Generate link</button>
      <button class="ghost" id="copy" disabled>Copy link</button>
      <button class="ghost" id="open" disabled>Open page</button>
      <button class="ghost" id="reset" type="button">Reset</button>
    </div>

    <div class="out" id="out">
      <div class="small">Your shareable link:</div>
      <code id="link"></code>
      <div class="small" style="margin-top:10px">
        Tip: Don‚Äôt include very sensitive secrets in the message.
      </div>
    </div>
  </div>

  <script>
    // URL-safe Base64 for payload (now tiny because we store only image URLs)
    function b64urlEncode(str){
      const b64 = btoa(unescape(encodeURIComponent(str)));
      return b64.replaceAll('+','-').replaceAll('/','_').replaceAll('=','');
    }

    function getBaseUrl(){
      const url = new URL(window.location.href);
      url.pathname = url.pathname.replace(/generator\.html$/,'index.html');
      url.hash = '';
      url.search = '';
      return url.toString();
    }

    const el = (id)=>document.getElementById(id);

    // Validate key
    if (typeof UPLOADCARE_PUBLIC_KEY === "undefined" || UPLOADCARE_PUBLIC_KEY === "UPLOADCARE_PUBLIC_KEY_HERE") {
      el("keyWarn").style.display = "block";
    }

    let uploadedUrls = []; // [url1, url2, ...]

    function renderCaptionsUI(urls){
      const box = el("memoriesUI");
      box.innerHTML = "";

      if(!urls.length){
        box.innerHTML = `<div class="pill">No photos uploaded (optional)</div>`;
        return;
      }

      urls.slice(0,4).forEach((url, i)=>{
        const wrap = document.createElement("div");
        wrap.className = "memItem";

        const pill = document.createElement("div");
        pill.className = "pill";
        pill.textContent = `Photo ${i+1} uploaded`;

        const input = document.createElement("input");
        input.id = `cap_${i}`;
        input.maxLength = 120;
        input.placeholder = "Caption (e.g., Our first trip together ‚ú®)";

        wrap.appendChild(pill);
        wrap.appendChild(input);
        box.appendChild(wrap);
      });
    }

    renderCaptionsUI([]);

    // Uploadcare widget
    const widget = uploadcare.Widget('#uploader');

    widget.onChange(function(fileOrGroup){
      uploadedUrls = [];
      renderCaptionsUI([]);

      if(!fileOrGroup) return;

      // multiple uploads return a Group
      fileOrGroup.promise().then(function(info){
        // If group: info.files() is available
        if(typeof info.files === "function"){
          return info.files();
        }
        // If single: wrap it
        return [info];
      }).then(function(files){
        const proms = files.slice(0,4).map(f => f.promise());
        return Promise.all(proms);
      }).then(function(fileInfos){
        uploadedUrls = fileInfos.slice(0,4).map(fi => fi.cdnUrl);
        renderCaptionsUI(uploadedUrls);
      }).catch(function(){
        uploadedUrls = [];
        renderCaptionsUI([]);
      });
    });

    function makePayload(){
      const toName = el('toName').value.trim();
      const fromName = el('fromName').value.trim();
      const msg = el('msg').value.trim();
      const theme = el('theme').value;
      const endingLine = (el('endingLine').value.trim() || "These are just a few of my favorite moments with you üíå").slice(0,120);

      if(!toName) throw new Error("Please enter a name.");
      if(!msg) throw new Error("Please enter a message.");

      // Build memories array: [{url, text}]
      const memories = uploadedUrls.slice(0,4).map((url, i)=>({
        url,
        text: (document.getElementById(`cap_${i}`)?.value || "").trim().slice(0,120)
      }));

      return { toName, fromName, msg, theme, endingLine, memories };
    }

    let lastLink = "";

    el('gen').addEventListener('click', ()=>{
      try{
        const payload = makePayload();
        const encoded = b64urlEncode(JSON.stringify(payload));
        lastLink = getBaseUrl() + "#d=" + encoded;

        el('link').textContent = lastLink;
        el('out').style.display = "block";
        el('copy').disabled = false;
        el('open').disabled = false;

      } catch(err){
        alert(err.message || String(err));
      }
    });

    el('copy').addEventListener('click', async ()=>{
      try{
        await navigator.clipboard.writeText(lastLink);
        alert("Copied!");
      }catch{
        alert("Copy failed. You can manually select the link and copy it.");
      }
    });

    el('open').addEventListener('click', ()=>{
      if(lastLink) window.open(lastLink, "_blank");
    });

    el('reset').addEventListener('click', ()=>{
      ['toName','fromName','msg','endingLine'].forEach(id=>el(id).value="");
      el('theme').value="rose";
      widget.value(null);
      uploadedUrls = [];
      renderCaptionsUI([]);
      el('out').style.display="none";
      el('copy').disabled=true;
      el('open').disabled=true;
      lastLink="";
    });
  </script>
</body>
</html>

